import streamlit as st
import pandas as pd
import numpy as np
from datetime import datetime, timedelta
import plotly.express as px
import plotly.graph_objects as go
from io import StringIO

# ุฅุนุฏุงุฏ ุงูุตูุญุฉ
st.set_page_config(page_title="ูุธุงู ุงูุชุญููู ุงูุดุงูู", layout="wide", initial_sidebar_state="expanded")

# ุงูุนููุงู ุงูุฑุฆูุณู
st.title("๐ฏ ูุธุงู ุงูุชุญููู ุงูุดุงูู ููุจูุงูุงุช")
st.markdown("---")

# ุชุนุฑูู ุงููุฌููุนุงุช ูุงูุฃุนูุฏุฉ ุงููุทููุจุฉ
ANALYSIS_GROUPS = {
    "ุงููุฌููุนุฉ 1: ุชุญููู ุงููุจูุนุงุช ุงูุฃุณุงุณู": {
        "analyses": [
            "1. ุฅุฌูุงูู ุงููุจูุนุงุช",
            "2. ุฅุฌูุงูู ุงูุฃุฑุจุงุญ",
            "3. ุฃูุถู 10 ููุชุฌุงุช ูุจูุนูุง",
            "4. ุฃูู 10 ููุชุฌุงุช ูุจูุนูุง",
            "5. ุชุญููู ุงููุจูุนุงุช ุญุณุจ ุงูููุทูุฉ",
            "6. ุชุญููู ุงููุจูุนุงุช ุญุณุจ ุงููุฆุฉ",
            "7. ุชุญููู ุงููุจูุนุงุช ุญุณุจ ุงูุนููู",
            "8. ุชุญููู ุงููุจูุนุงุช ุญุณุจ ุงูุดูุฑ",
            "9. ุชุญููู ุงููุจูุนุงุช ุญุณุจ ุงูููู",
            "10. ุชุญููู ุงููุจูุนุงุช ุญุณุจ ุงูุฑุจุน ุงููุงูู"
        ],
        "required_columns": ["ุงูุชุงุฑูุฎ", "ุงูููุชุฌ", "ุงููุฆุฉ", "ุงูููุทูุฉ", "ุงูุนููู", "ุงููููุฉ", "ุณุนุฑ_ุงูุจูุน", "ุงูุชูููุฉ"]
    },
    "ุงููุฌููุนุฉ 2: ุชุญููู ุงููุจูุนุงุช ุงููุชูุฏู": {
        "analyses": [
            "11. ูุนุฏู ุงูุฑุจุญ ููู ููุชุฌ",
            "12. ูุนุฏู ุงูุฑุจุญ ููู ูุฆุฉ",
            "13. ุชุญููู ูุชูุณุท ุณุนุฑ ุงูุจูุน",
            "14. ุชุญููู ูุงูุด ุงูุฑุจุญ ููู ููุชุฌ",
            "15. ุชุญููู ุงููุจูุนุงุช ุญุณุจ ุงูููุงุฉ",
            "16. ุชุญููู ุงููุจูุนุงุช ุญุณุจ ุงููุฎุฒูู",
            "17. ุชุญููู ุงููุจูุนุงุช ุงูููุณููุฉ",
            "18. ุชุญููู ุงููุจูุนุงุช ุญุณุจ ุงูุชุฑููุฌ",
            "19. ุชุญููู ุงููุจูุนุงุช ุงูููููุฉ",
            "20. ุชุญููู ุงููุจูุนุงุช ุงูุฃุณุจูุนูุฉ"
        ],
        "required_columns": ["ุงูุชุงุฑูุฎ", "ุงูููุชุฌ", "ุงููุฆุฉ", "ุงูููุงุฉ", "ุงููููุฉ", "ุณุนุฑ_ุงูุจูุน", "ุงูุชูููุฉ", "ุงูุชุฑููุฌ", "ุงููุฎุฒูู"]
    },
    "ุงููุฌููุนุฉ 3: ุชุญููู ุงููุฎุฒูู ุงูุฃุณุงุณู": {
        "analyses": [
            "21. ุฅุฌูุงูู ุงููุฎุฒูู",
            "22. ุงููุฎุฒูู ุญุณุจ ุงูููุชุฌ",
            "23. ุงููุฎุฒูู ุญุณุจ ุงููุฆุฉ",
            "24. ุงููุฎุฒูู ุญุณุจ ุงููุณุชูุฏุน",
            "25. ุงูููุชุฌุงุช ููุฎูุถุฉ ุงููุฎุฒูู",
            "26. ุงูููุชุฌุงุช ุนุงููุฉ ุงููุฎุฒูู",
            "27. ูุนุฏู ุฏูุฑุงู ุงููุฎุฒูู",
            "28. ุงููุฎุฒูู ุงููุชููุน",
            "29. ุงููุฎุฒูู ุงูุฃููู",
            "30. ุชุญููู ุงูููุชุฌุงุช ุงููุชูุงุฏูุฉ"
        ],
        "required_columns": ["ุงูููุชุฌ", "ุงููุฆุฉ", "ุงููุณุชูุฏุน", "ุงููููุฉ_ุงูุญุงููุฉ", "ุงูุญุฏ_ุงูุฃุฏูู", "ุงูุญุฏ_ุงูุฃูุตู", "ุชุงุฑูุฎ_ุงูุฅุถุงูุฉ", "ุงููุจูุนุงุช_ุงูุดูุฑูุฉ"]
    },
    "ุงููุฌููุนุฉ 4: ุชุญููู ุงููุฎุฒูู ุงููุชูุฏู": {
        "analyses": [
            "31. ุชุญููู ุงูููุชุฌุงุช ุญุณุจ ุงูุนูุฑ ูู ุงููุฎุฒูู",
            "32. ุชุญููู ุงูููุชุฌุงุช ุญุณุจ ุงููุจูุนุงุช",
            "33. ุชุญููู ุงูุทูุจ ุงููุณุชูุจูู",
            "34. ุงููุฎุฒูู ุญุณุจ ุงูููุฑุฏ",
            "35. ุงููุฎุฒูู ุญุณุจ ุงูููุทูุฉ",
            "36. ุชุญููู ุงููุฎุฒูู ุจูุงุกู ุนูู ุงูููุณู",
            "37. ุงููุฎุฒูู ุญุณุจ ุณุนุฑ ุงูุจูุน",
            "38. ูุนุฏู ุงุณุชููุงู ุงููุฎุฒูู",
            "39. ุชุญููู ุงูุทูุจ ููุงุจู ุงููุฎุฒูู",
            "40. ุงููุฎุฒูู ุญุณุจ ุงููุฆุฉ ุงูุนููุง"
        ],
        "required_columns": ["ุงูููุชุฌ", "ุงููุฆุฉ", "ุงูููุฑุฏ", "ุงูููุทูุฉ", "ุงููููุฉ_ุงูุญุงููุฉ", "ุชุงุฑูุฎ_ุงูุฅุถุงูุฉ", "ุณุนุฑ_ุงูุจูุน", "ุงููุจูุนุงุช_ุงูููููุฉ", "ุงูููุณู"]
    },
    "ุงููุฌููุนุฉ 5: ุชุญููู ุงูููุธููู ุงูุฃุณุงุณู": {
        "analyses": [
            "41. ุนุฏุฏ ุงูููุธููู ุญุณุจ ุงููุณู",
            "42. ุนุฏุฏ ุงูููุธููู ุญุณุจ ุงูุฏูุฑ",
            "43. ูุชูุณุท ุงูุฑุงุชุจ ุญุณุจ ุงููุณู",
            "44. ูุชูุณุท ุงูุฑุงุชุจ ุญุณุจ ุงูุฏูุฑ",
            "45. ุงูุชูุธูู ุงูุดูุฑู",
            "46. ูุนุฏู ุงูุงุณุชูุงูุงุช",
            "47. ุชุญููู ุงูุบูุงุจ",
            "48. ุชุญููู ุงูุญุถูุฑ",
            "49. ุชุญููู ุงูุนูุฑ ุงููุธููู",
            "50. ุชุญููู ุงูููุธููู ุงูุฌุฏุฏ"
        ],
        "required_columns": ["ุงูููุธู", "ุงููุณู", "ุงูุฏูุฑ", "ุงูุฑุงุชุจ", "ุชุงุฑูุฎ_ุงูุชูุธูู", "ุชุงุฑูุฎ_ุงูุงุณุชูุงูุฉ", "ุฃูุงู_ุงูุบูุงุจ", "ุฃูุงู_ุงูุญุถูุฑ"]
    },
    "ุงููุฌููุนุฉ 6: ุชุญููู ุงูููุธููู ุงููุชูุฏู": {
        "analyses": [
            "51. ุฃุนูู ุงูุฑูุงุชุจ",
            "52. ุฃูู ุงูุฑูุงุชุจ",
            "53. ุชูุฒูุน ุงูุฑูุงุชุจ",
            "54. ุชูููู ุงูุฃุฏุงุก ุงูุณููู",
            "55. ุงูุฃุฏุงุก ุญุณุจ ุงููุณู",
            "56. ุงูุฃุฏุงุก ุญุณุจ ุงูุฏูุฑ",
            "57. ูุชูุณุท ุงูุบูุงุจ ุญุณุจ ุงููุณู",
            "58. ูุชูุณุท ุงูุบูุงุจ ุญุณุจ ุงูุฏูุฑ",
            "59. ูุชูุณุท ุงูุนูุฑ ุงููุธููู",
            "60. ุชุญููู ุงูููุธููู ุงููุณุชูุฏููู ููุชุฑููุฉ"
        ],
        "required_columns": ["ุงูููุธู", "ุงููุณู", "ุงูุฏูุฑ", "ุงูุฑุงุชุจ", "ุชุงุฑูุฎ_ุงูุชูุธูู", "ุชูููู_ุงูุฃุฏุงุก", "ุฃูุงู_ุงูุบูุงุจ", "ูุคูู_ููุชุฑููุฉ"]
    },
    "ุงููุฌููุนุฉ 7: ุชุญููู ุงูุนููุงุก ุงูุฃุณุงุณู": {
        "analyses": [
            "61. ุนุฏุฏ ุงูุนููุงุก ุงูููู",
            "62. ุงูุนููุงุก ุงูุฌุฏุฏ",
            "63. ุงูุนููุงุก ุงููุดุทูู",
            "64. ุงูุนููุงุก ุบูุฑ ุงููุดุทูู",
            "65. ุฃูุถู ุงูุนููุงุก ุญุณุจ ุงููุจูุนุงุช",
            "66. ุฃูู ุงูุนููุงุก ุญุณุจ ุงููุจูุนุงุช",
            "67. ุงูุนููุงุก ุญุณุจ ุงูููุทูุฉ",
            "68. ุงูุนููุงุก ุญุณุจ ุงููุฆุฉ",
            "69. ุงูุนููุงุก ุญุณุจ ุงูุนูุฑ",
            "70. ุงูุนููุงุก ุญุณุจ ุงูุฌูุณ"
        ],
        "required_columns": ["ุงูุนููู", "ุงูููุทูุฉ", "ุงููุฆุฉ", "ุงูุนูุฑ", "ุงูุฌูุณ", "ุชุงุฑูุฎ_ุงูุชุณุฌูู", "ุขุฎุฑ_ุนูููุฉ_ุดุฑุงุก", "ุฅุฌูุงูู_ุงููุดุชุฑูุงุช"]
    },
    "ุงููุฌููุนุฉ 8: ุชุญููู ุงูุนููุงุก ุงููุชูุฏู": {
        "analyses": [
            "71. ูุนุฏู ุงูุงุญุชูุงุธ ุจุงูุนููุงุก",
            "72. ูุนุฏู ููุฏุงู ุงูุนููุงุก",
            "73. ุงูุนููุงุก ุงููุญุชูููู (Leads)",
            "74. ูุนุฏู ุงูุชุญููู ูู Lead ุฅูู ุนููู",
            "75. ูุชูุณุท ุงูุฅููุงู ููู ุนููู",
            "76. ุงูุนููุงุก ุงูุนุงุฆุฏูู",
            "77. ุงูุนููุงุก ุงูุฐูู ูู ูุดุชุฑูุง ููุฐ ูุชุฑุฉ",
            "78. ุงูุนููุงุก ุญุณุจ ุงูุชูุงุนู",
            "79. ุงูุนููุงุก ุญุณุจ ุงูููุงุฉ",
            "80. ุงูุนููุงุก ุญุณุจ ุงูููุชุฌุงุช ุงููุดุชุฑูุฉ"
        ],
        "required_columns": ["ุงูุนููู", "ุชุงุฑูุฎ_ุงูุชุณุฌูู", "ุขุฎุฑ_ุนูููุฉ_ุดุฑุงุก", "ุนุฏุฏ_ุงููุดุชุฑูุงุช", "ุฅุฌูุงูู_ุงููุดุชุฑูุงุช", "ุงูููุงุฉ", "ุญุงูุฉ_ุงูุนููู", "ุงูุชูุงุนู"]
    },
    "ุงููุฌููุนุฉ 9: ุชุญููู ุงูุชุณููู ุงูุฃุณุงุณู": {
        "analyses": [
            "81. ุนุฏุฏ ุงูุฒูุงุฑ ุงูููู",
            "82. ุงูุฒูุงุฑ ุญุณุจ ุงููุตุฏุฑ",
            "83. ุงูุฒูุงุฑ ุญุณุจ ุงูููุงุฉ",
            "84. ูุนุฏู ุงูููุฑ CTR",
            "85. ูุนุฏู ุงูุชุญููู",
            "86. ูุนุฏู ุงูุงุฑุชุฏุงุฏ",
            "87. ุงููุดุชุฑููู ุงูุฌุฏุฏ",
            "88. ุงููุดุชุฑููู ุงููุดุทูู",
            "89. ุงููุดุชุฑููู ุบูุฑ ุงููุดุทูู",
            "90. ุงูุญููุงุช ุงูุฅุนูุงููุฉ ุงูุฃูุซุฑ ูุนุงููุฉ"
        ],
        "required_columns": ["ุงูุชุงุฑูุฎ", "ุงููุตุฏุฑ", "ุงูููุงุฉ", "ุนุฏุฏ_ุงูุฒูุงุฑ", "ุงูููุฑุงุช", "ุงูุชุญูููุงุช", "ูุนุฏู_ุงูุงุฑุชุฏุงุฏ", "ุงูุญููุฉ"]
    },
    "ุงููุฌููุนุฉ 10: ุชุญููู ุงูุชุณููู ุงููุชูุฏู": {
        "analyses": [
            "91. ุชูููุฉ ุงูุงูุชุณุงุจ ููู ุนููู (CAC)",
            "92. ุงูุนุงุฆุฏ ุนูู ุงูุงุณุชุซูุงุฑ ุงูุฅุนูุงูู (ROAS)",
            "93. ุงูุฅูุฑุงุฏุงุช ุญุณุจ ุงูููุงุฉ",
            "94. ุงูุฅูุฑุงุฏุงุช ุญุณุจ ุงูุญููุฉ",
            "95. ุงูุฅูุฑุงุฏุงุช ุญุณุจ ุงููุฆุฉ",
            "96. ุชุญููู ุงูุชูุงุนู ุญุณุจ ุงููุญุชูู",
            "97. ุชุญููู ุงูุชูุงุนู ุญุณุจ ุงูุฒูุงู",
            "98. ุชุญููู ุงูุชูุงุนู ุญุณุจ ุงูููุงุฉ",
            "99. ุชููุน ุงูุญููุงุช ุงูุฅุนูุงููุฉ ุงููุงุฏูุฉ",
            "100. ุชุญููู ุงููุจูุนุงุช ุงููุงุชุฌุฉ ุนู ุงูุญููุงุช"
        ],
        "required_columns": ["ุงูุชุงุฑูุฎ", "ุงูููุงุฉ", "ุงูุญููุฉ", "ุงููุฆุฉ", "ุงูุชูููุฉ", "ุงูุฅูุฑุงุฏุงุช", "ุงูุชุญูููุงุช", "ุงูุชูุงุนู", "ุงููุญุชูู"]
    },
    "ุงููุฌููุนุฉ 11: ุชุญููู ุงูุทูุงุจ ุงูุฃุณุงุณู": {
        "analyses": [
            "101. ุนุฏุฏ ุงูุทูุงุจ ุงูููู",
            "102. ุงูุทูุงุจ ุญุณุจ ุงูุตู",
            "103. ุงูุทูุงุจ ุญุณุจ ุงููุตู",
            "104. ูุชูุณุท ุงูุฏุฑุฌุงุช",
            "105. ุฃุนูู ุงูุทูุงุจ",
            "106. ุฃูู ุงูุทูุงุจ",
            "107. ุงูุทูุงุจ ุญุณุจ ุงูุนูุฑ",
            "108. ุงูุทูุงุจ ุญุณุจ ุงูุฌูุณ",
            "109. ุงูุทูุงุจ ุญุณุจ ุงููุงุฏุฉ",
            "110. ุงูุทูุงุจ ุญุณุจ ุงูุฃุฏุงุก"
        ],
        "required_columns": ["ุงูุทุงูุจ", "ุงูุตู", "ุงููุตู", "ุงูุนูุฑ", "ุงูุฌูุณ", "ุงููุงุฏุฉ", "ุงูุฏุฑุฌุฉ", "ุงูุญุถูุฑ"]
    },
    "ุงููุฌููุนุฉ 12: ุชุญููู ุงูุทูุงุจ ุงููุชูุฏู": {
        "analyses": [
            "111. ูุนุฏู ุงููุฌุงุญ ูุงูุฑุณูุจ",
            "112. ุชูุฒูุน ุงูุฏุฑุฌุงุช",
            "113. ุงูุทูุงุจ ุญุณุจ ุงูุญุถูุฑ",
            "114. ุงูุทูุงุจ ุญุณุจ ุงูุบูุงุจ",
            "115. ุงูุทูุงุจ ุงููุชููููู",
            "116. ุงูุทูุงุจ ุงููุญุชุงุฌูู ูุฏุนู",
            "117. ููุงุฑูุฉ ุงูุตููู",
            "118. ููุงุฑูุฉ ุงูููุงุฏ",
            "119. ุชุญููู ุงูุฃุฏุงุก ุญุณุจ ุงููุนูู",
            "120. ุชููุน ุงูุฃุฏุงุก ุงููุณุชูุจูู"
        ],
        "required_columns": ["ุงูุทุงูุจ", "ุงูุตู", "ุงููุตู", "ุงููุงุฏุฉ", "ุงูุฏุฑุฌุฉ", "ุงูุญุถูุฑ", "ุงูุบูุงุจ", "ุงููุนูู", "ุงูุญุงูุฉ"]
    },
    "ุงููุฌููุนุฉ 13: ุชุญููู ุงููุดุชุฑูุงุช ุงูุฃุณุงุณู": {
        "analyses": [
            "121. ุฅุฌูุงูู ุงููุดุชุฑูุงุช",
            "122. ุงููุดุชุฑูุงุช ุญุณุจ ุงูููุฑุฏ",
            "123. ุงููุดุชุฑูุงุช ุญุณุจ ุงูููุชุฌ",
            "124. ุงููุดุชุฑูุงุช ุงูุดูุฑูุฉ",
            "125. ุงููุดุชุฑูุงุช ุญุณุจ ุงููุฆุฉ",
            "126. ุฃุนูู ุงูููุฑุฏูู ุชูููุฉ",
            "127. ุฃูู ุงูููุฑุฏูู ุชูููุฉ",
            "128. ูุชูุณุท ุชูููุฉ ุงูููุชุฌ",
            "129. ุชุญููู ุงูุทูุจ ููุงุจู ุงููุฎุฒูู",
            "130. ุงููุดุชุฑูุงุช ุญุณุจ ุงูููุงุฉ"
        ],
        "required_columns": ["ุงูุชุงุฑูุฎ", "ุงูููุฑุฏ", "ุงูููุชุฌ", "ุงููุฆุฉ", "ุงููููุฉ", "ุงูุชูููุฉ", "ุงูููุงุฉ"]
    },
    "ุงููุฌููุนุฉ 14: ุชุญููู ุงููุดุชุฑูุงุช ุงููุชูุฏู": {
        "analyses": [
            "131. ุชุญููู ุงูุชุณููู ูู ุงูููุช ุงููุญุฏุฏ",
            "132. ุชุญููู ุงูุทูุจุงุช ุงููุชุฃุฎุฑุฉ",
            "133. ุชุญููู ุงูููุฑุฏูู ุญุณุจ ุงูุฃุฏุงุก",
            "134. ุชุญููู ุชูููุฉ ุงูููู",
            "135. ุชููุน ุงููุดุชุฑูุงุช ุงููุณุชูุจููุฉ",
            "136. ูุนุฏู ุฏูุฑุงู ุงููุดุชุฑูุงุช",
            "137. ุชุญููู ุงููุฎุฒูู ุงููุฑุชุจุท ุจุงููุดุชุฑูุงุช",
            "138. ุชุญููู ุงูุนุฑูุถ ุงูุชุฑููุฌูุฉ ููููุฑุฏูู",
            "139. ุชุญููู ุงููุฎุฒูู ุงูุฃููู",
            "140. ุฅูุดุงุก ุชูุฑูุฑ ูุดุชุฑูุงุช ูุงูู"
        ],
        "required_columns": ["ุงูุชุงุฑูุฎ", "ุงูููุฑุฏ", "ุงูููุชุฌ", "ุงููููุฉ", "ุงูุชูููุฉ", "ุชุงุฑูุฎ_ุงูุชุณููู_ุงููุชููุน", "ุชุงุฑูุฎ_ุงูุชุณููู_ุงููุนูู", "ุชูููุฉ_ุงูููู", "ุงูุฃุฏุงุก"]
    }
}

# ุฏูุงู ุงูุชุญููู
def analyze_sales_basic(df, analysis_num):
    """ุชุญููู ุงููุจูุนุงุช ุงูุฃุณุงุณู"""
    if analysis_num == 1:
        total = (df['ุงููููุฉ'] * df['ุณุนุฑ_ุงูุจูุน']).sum()
        st.metric("ุฅุฌูุงูู ุงููุจูุนุงุช", f"{total:,.2f} ุฌููู")
        
    elif analysis_num == 2:
        profit = ((df['ุณุนุฑ_ุงูุจูุน'] - df['ุงูุชูููุฉ']) * df['ุงููููุฉ']).sum()
        st.metric("ุฅุฌูุงูู ุงูุฃุฑุจุงุญ", f"{profit:,.2f} ุฌููู")
        
    elif analysis_num == 3:
        top = df.groupby('ุงูููุชุฌ').apply(lambda x: (x['ุงููููุฉ'] * x['ุณุนุฑ_ุงูุจูุน']).sum()).nlargest(10)
        fig = px.bar(x=top.values, y=top.index, orientation='h', title="ุฃูุถู 10 ููุชุฌุงุช ูุจูุนูุง")
        st.plotly_chart(fig, use_container_width=True)
        
    elif analysis_num == 4:
        bottom = df.groupby('ุงูููุชุฌ').apply(lambda x: (x['ุงููููุฉ'] * x['ุณุนุฑ_ุงูุจูุน']).sum()).nsmallest(10)
        fig = px.bar(x=bottom.values, y=bottom.index, orientation='h', title="ุฃูู 10 ููุชุฌุงุช ูุจูุนูุง")
        st.plotly_chart(fig, use_container_width=True)
        
    elif analysis_num == 5:
        by_region = df.groupby('ุงูููุทูุฉ').apply(lambda x: (x['ุงููููุฉ'] * x['ุณุนุฑ_ุงูุจูุน']).sum())
        fig = px.pie(values=by_region.values, names=by_region.index, title="ุงููุจูุนุงุช ุญุณุจ ุงูููุทูุฉ")
        st.plotly_chart(fig, use_container_width=True)
        
    elif analysis_num == 6:
        by_cat = df.groupby('ุงููุฆุฉ').apply(lambda x: (x['ุงููููุฉ'] * x['ุณุนุฑ_ุงูุจูุน']).sum())
        fig = px.bar(x=by_cat.index, y=by_cat.values, title="ุงููุจูุนุงุช ุญุณุจ ุงููุฆุฉ")
        st.plotly_chart(fig, use_container_width=True)
        
    elif analysis_num == 7:
        by_customer = df.groupby('ุงูุนููู').apply(lambda x: (x['ุงููููุฉ'] * x['ุณุนุฑ_ุงูุจูุน']).sum()).nlargest(15)
        fig = px.bar(x=by_customer.index, y=by_customer.values, title="ุงููุจูุนุงุช ุญุณุจ ุงูุนููู (ุฃูุถู 15)")
        st.plotly_chart(fig, use_container_width=True)
        
    elif analysis_num == 8:
        df['ุงูุดูุฑ'] = pd.to_datetime(df['ุงูุชุงุฑูุฎ']).dt.to_period('M').astype(str)
        by_month = df.groupby('ุงูุดูุฑ').apply(lambda x: (x['ุงููููุฉ'] * x['ุณุนุฑ_ุงูุจูุน']).sum())
        fig = px.line(x=by_month.index, y=by_month.values, title="ุงููุจูุนุงุช ุญุณุจ ุงูุดูุฑ")
        st.plotly_chart(fig, use_container_width=True)
        
    elif analysis_num == 9:
        df['ุงูููู'] = pd.to_datetime(df['ุงูุชุงุฑูุฎ']).dt.date
        by_day = df.groupby('ุงูููู').apply(lambda x: (x['ุงููููุฉ'] * x['ุณุนุฑ_ุงูุจูุน']).sum())
        fig = px.line(x=by_day.index, y=by_day.values, title="ุงููุจูุนุงุช ุญุณุจ ุงูููู")
        st.plotly_chart(fig, use_container_width=True)
        
    elif analysis_num == 10:
        df['ุงูุฑุจุน'] = pd.to_datetime(df['ุงูุชุงุฑูุฎ']).dt.to_period('Q').astype(str)
        by_quarter = df.groupby('ุงูุฑุจุน').apply(lambda x: (x['ุงููููุฉ'] * x['ุณุนุฑ_ุงูุจูุน']).sum())
        fig = px.bar(x=by_quarter.index, y=by_quarter.values, title="ุงููุจูุนุงุช ุญุณุจ ุงูุฑุจุน ุงููุงูู")
        st.plotly_chart(fig, use_container_width=True)

def analyze_sales_advanced(df, analysis_num):
    """ุชุญููู ุงููุจูุนุงุช ุงููุชูุฏู"""
    if analysis_num == 11:
        df['ุงูุฑุจุญ'] = (df['ุณุนุฑ_ุงูุจูุน'] - df['ุงูุชูููุฉ']) * df['ุงููููุฉ']
        df['ุงููุจูุนุงุช'] = df['ุงููููุฉ'] * df['ุณุนุฑ_ุงูุจูุน']
        profit_rate = df.groupby('ุงูููุชุฌ').apply(lambda x: (x['ุงูุฑุจุญ'].sum() / x['ุงููุจูุนุงุช'].sum() * 100))
        fig = px.bar(x=profit_rate.index, y=profit_rate.values, title="ูุนุฏู ุงูุฑุจุญ ููู ููุชุฌ (%)")
        st.plotly_chart(fig, use_container_width=True)
        
    elif analysis_num == 12:
        df['ุงูุฑุจุญ'] = (df['ุณุนุฑ_ุงูุจูุน'] - df['ุงูุชูููุฉ']) * df['ุงููููุฉ']
        df['ุงููุจูุนุงุช'] = df['ุงููููุฉ'] * df['ุณุนุฑ_ุงูุจูุน']
        profit_rate = df.groupby('ุงููุฆุฉ').apply(lambda x: (x['ุงูุฑุจุญ'].sum() / x['ุงููุจูุนุงุช'].sum() * 100))
        fig = px.bar(x=profit_rate.index, y=profit_rate.values, title="ูุนุฏู ุงูุฑุจุญ ููู ูุฆุฉ (%)")
        st.plotly_chart(fig, use_container_width=True)
        
    elif analysis_num == 13:
        avg_price = df.groupby('ุงูููุชุฌ')['ุณุนุฑ_ุงูุจูุน'].mean()
        fig = px.bar(x=avg_price.index, y=avg_price.values, title="ูุชูุณุท ุณุนุฑ ุงูุจูุน ููู ููุชุฌ")
        st.plotly_chart(fig, use_container_width=True)
        
    elif analysis_num == 14:
        df['ูุงูุด_ุงูุฑุจุญ'] = ((df['ุณุนุฑ_ุงูุจูุน'] - df['ุงูุชูููุฉ']) / df['ุณุนุฑ_ุงูุจูุน'] * 100)
        margin = df.groupby('ุงูููุชุฌ')['ูุงูุด_ุงูุฑุจุญ'].mean()
        fig = px.bar(x=margin.index, y=margin.values, title="ูุงูุด ุงูุฑุจุญ ููู ููุชุฌ (%)")
        st.plotly_chart(fig, use_container_width=True)
        
    elif analysis_num == 15:
        by_channel = df.groupby('ุงูููุงุฉ').apply(lambda x: (x['ุงููููุฉ'] * x['ุณุนุฑ_ุงูุจูุน']).sum())
        fig = px.pie(values=by_channel.values, names=by_channel.index, title="ุงููุจูุนุงุช ุญุณุจ ุงูููุงุฉ")
        st.plotly_chart(fig, use_container_width=True)
        
    elif analysis_num == 16:
        sales_inv = df.groupby('ุงูููุชุฌ').agg({'ุงููููุฉ': 'sum', 'ุงููุฎุฒูู': 'mean'})
        fig = px.scatter(sales_inv, x='ุงููุฎุฒูู', y='ุงููููุฉ', text=sales_inv.index, title="ุงููุจูุนุงุช ููุงุจู ุงููุฎุฒูู")
        st.plotly_chart(fig, use_container_width=True)
        
    elif analysis_num == 17:
        df['ุงูุดูุฑ'] = pd.to_datetime(df['ุงูุชุงุฑูุฎ']).dt.month
        seasonal = df.groupby('ุงูุดูุฑ').apply(lambda x: (x['ุงููููุฉ'] * x['ุณุนุฑ_ุงูุจูุน']).sum())
        fig = px.line(x=seasonal.index, y=seasonal.values, title="ุงููุจูุนุงุช ุงูููุณููุฉ")
        st.plotly_chart(fig, use_container_width=True)
        
    elif analysis_num == 18:
        by_promo = df.groupby('ุงูุชุฑููุฌ').apply(lambda x: (x['ุงููููุฉ'] * x['ุณุนุฑ_ุงูุจูุน']).sum())
        fig = px.bar(x=by_promo.index, y=by_promo.values, title="ุงููุจูุนุงุช ุญุณุจ ุงูุชุฑููุฌ")
        st.plotly_chart(fig, use_container_width=True)
        
    elif analysis_num == 19:
        df['ุงูููู'] = pd.to_datetime(df['ุงูุชุงุฑูุฎ']).dt.date
        daily = df.groupby('ุงูููู').apply(lambda x: (x['ุงููููุฉ'] * x['ุณุนุฑ_ุงูุจูุน']).sum())
        fig = px.line(x=daily.index, y=daily.values, title="ุงููุจูุนุงุช ุงูููููุฉ")
        st.plotly_chart(fig, use_container_width=True)
        
    elif analysis_num == 20:
        df['ุงูุฃุณุจูุน'] = pd.to_datetime(df['ุงูุชุงุฑูุฎ']).dt.to_period('W').astype(str)
        weekly = df.groupby('ุงูุฃุณุจูุน').apply(lambda x: (x['ุงููููุฉ'] * x['ุณุนุฑ_ุงูุจูุน']).sum())
        fig = px.line(x=weekly.index, y=weekly.values, title="ุงููุจูุนุงุช ุงูุฃุณุจูุนูุฉ")
        st.plotly_chart(fig, use_container_width=True)

def analyze_inventory_basic(df, analysis_num):
    """ุชุญููู ุงููุฎุฒูู ุงูุฃุณุงุณู"""
    if analysis_num == 21:
        total = df['ุงููููุฉ_ุงูุญุงููุฉ'].sum()
        st.metric("ุฅุฌูุงูู ุงููุฎุฒูู", f"{total:,.0f} ูุญุฏุฉ")
        
    elif analysis_num == 22:
        by_product = df.groupby('ุงูููุชุฌ')['ุงููููุฉ_ุงูุญุงููุฉ'].sum()
        fig = px.bar(x=by_product.index, y=by_product.values, title="ุงููุฎุฒูู ุญุณุจ ุงูููุชุฌ")
        st.plotly_chart(fig, use_container_width=True)
        
    elif analysis_num == 23:
        by_cat = df.groupby('ุงููุฆุฉ')['ุงููููุฉ_ุงูุญุงููุฉ'].sum()
        fig = px.pie(values=by_cat.values, names=by_cat.index, title="ุงููุฎุฒูู ุญุณุจ ุงููุฆุฉ")
        st.plotly_chart(fig, use_container_width=True)
        
    elif analysis_num == 24:
        by_warehouse = df.groupby('ุงููุณุชูุฏุน')['ุงููููุฉ_ุงูุญุงููุฉ'].sum()
        fig = px.bar(x=by_warehouse.index, y=by_warehouse.values, title="ุงููุฎุฒูู ุญุณุจ ุงููุณุชูุฏุน")
        st.plotly_chart(fig, use_container_width=True)
        
    elif analysis_num == 25:
        low = df[df['ุงููููุฉ_ุงูุญุงููุฉ'] < df['ุงูุญุฏ_ุงูุฃุฏูู']]
        st.write(f"ุนุฏุฏ ุงูููุชุฌุงุช ููุฎูุถุฉ ุงููุฎุฒูู: {len(low)}")
        st.dataframe(low[['ุงูููุชุฌ', 'ุงููููุฉ_ุงูุญุงููุฉ', 'ุงูุญุฏ_ุงูุฃุฏูู']])
        
    elif analysis_num == 26:
        high = df[df['ุงููููุฉ_ุงูุญุงููุฉ'] > df['ุงูุญุฏ_ุงูุฃูุตู']]
        st.write(f"ุนุฏุฏ ุงูููุชุฌุงุช ุนุงููุฉ ุงููุฎุฒูู: {len(high)}")
        st.dataframe(high[['ุงูููุชุฌ', 'ุงููููุฉ_ุงูุญุงููุฉ', 'ุงูุญุฏ_ุงูุฃูุตู']])
        
    elif analysis_num == 27:
        df['ูุนุฏู_ุงูุฏูุฑุงู'] = df['ุงููุจูุนุงุช_ุงูุดูุฑูุฉ'] / df['ุงููููุฉ_ุงูุญุงููุฉ']
        turnover = df.groupby('ุงูููุชุฌ')['ูุนุฏู_ุงูุฏูุฑุงู'].mean()
        fig = px.bar(x=turnover.index, y=turnover.values, title="ูุนุฏู ุฏูุฑุงู ุงููุฎุฒูู")
        st.plotly_chart(fig, use_container_width=True)
        
    elif analysis_num == 28:
        df['ุงููุฎุฒูู_ุงููุชููุน'] = df['ุงููููุฉ_ุงูุญุงููุฉ'] - (df['ุงููุจูุนุงุช_ุงูุดูุฑูุฉ'] / 30 * 7)
        expected = df.groupby('ุงูููุชุฌ')['ุงููุฎุฒูู_ุงููุชููุน'].mean()
        fig = px.bar(x=expected.index, y=expected.values, title="ุงููุฎุฒูู ุงููุชููุน (7 ุฃูุงู)")
        st.plotly_chart(fig, use_container_width=True)
        
    elif analysis_num == 29:
        safety = df.groupby('ุงูููุชุฌ')['ุงูุญุฏ_ุงูุฃุฏูู'].mean()
        fig = px.bar(x=safety.index, y=safety.values, title="ุงููุฎุฒูู ุงูุฃููู")
        st.plotly_chart(fig, use_container_width=True)
        
    elif analysis_num == 30:
        df['ุงูุนูุฑ'] = (pd.Timestamp.now() - pd.to_datetime(df['ุชุงุฑูุฎ_ุงูุฅุถุงูุฉ'])).dt.days
        obsolete = df[df['ุงูุนูุฑ'] > 180]
        st.write(f"
